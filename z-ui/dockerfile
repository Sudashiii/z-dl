FROM oven/bun:1 AS deps
WORKDIR /app
RUN if command -v apk >/dev/null 2>&1; then \
		apk add --no-cache python3 make g++; \
	elif command -v apt-get >/dev/null 2>&1; then \
		apt-get update && apt-get install -y --no-install-recommends python3 make g++ && rm -rf /var/lib/apt/lists/*; \
	else \
		echo "Unsupported base image: no apk/apt-get found" >&2; exit 1; \
	fi
COPY package.json bun.lock ./
COPY .npmrc ./
RUN bun install --frozen-lockfile --omit peer

FROM deps AS builder
COPY . .
RUN bun run build

FROM deps AS migrator
WORKDIR /app
COPY package.json ./
COPY drizzle.config.ts ./
COPY drizzle ./drizzle
COPY scripts ./scripts
COPY src/lib/server/infrastructure/db/schema.ts ./src/lib/server/infrastructure/db/schema.ts
CMD [ "bun", "run", "db:migrate" ]

FROM oven/bun:1 AS runtime
WORKDIR /app
COPY --from=builder /app/build build/
COPY --from=deps /app/node_modules node_modules/
COPY --from=builder /app/package.json ./
EXPOSE 3000
ENV NODE_ENV=production
CMD [ "bun", "./build" ]
